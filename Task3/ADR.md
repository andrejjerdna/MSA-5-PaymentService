# Шаблон ADR 
## Общая информация 

1. Автор ADR: Степанов Андрей 
2. Статус - Принят
3. Согласующие - Иван Иванов
4. Связанные решения: ADR-001 (Микросервисная декомпозиция), ADR-002 (Выбор паттерна Saga)

## Контекст
Ключевой бизнес-процесс OrchestrPay — обработка платежа на маркетплейсах. Основной сценарий, который вам предстоит спроектировать и разработать:
   - Пользователь оформляет заказ и инициирует платёж.
   - Система списывает деньги с его счёта.
   - Выполняется проверка в антифрод-системе и внешних сервисах (детализация этих проверок за скоупом задания).
   - Если проверка пройдена успешно, деньги переводятся контрагенту.
   - Если операция признаётся подозрительной — она блокируется, клиенту мгновенно возвращаются деньги, а в систему безопасности уходит уведомление для анализа.

Текущая организационная структура OrchestrPay выглядит так:
   - Отдел «Платёжные сервисы»: отвечает за разработку и развитие ключевых микросервисов платёжной платформы. Внутри отдела есть собственные команды, которые работают над отдельными доменами (например, обработка транзакций, возвраты, интеграции с внешними сервисами).
   - Отдел «Финансы»: взаимодействует с банками, платёжными шлюзами и системами бухгалтерского учёта. Отвечает за финансовую отчётность и сверку операций.
   - Команда «Customer Support»: обрабатывает обращения пользователей, связанные с платежами, сбоями и возвратами. Использует систему событий и интерфейсы для быстрой ручной обработки исключений.
   - Команда «Безопасность»: разрабатывает и внедряет antifraud-политики, анализирует угрозы, участвует в архитектурном контроле и проводит аудиты безопасности.
   - Команда «DevOps/SRE»: отвечает за стабильность, масштабируемость и автоматизацию инфраструктуры, мониторинг и логирование.

## Рассмотренные варианты

Рассмортрено выделения оркетратора в одельный сервис, а также создание оркестрации внутри доменных сервисов.

### Вариант №1 «Отдельный оркестратор»
**Описание:** Создание выделенного сервиса `PaymentSagaOrchestrator`, реализующего управление состоянием Saga через Camunda BPMN Engine. Сервис взаимодействует с доменными сервисами через асинхронные события/команды.

**Преимущества:**
- **Четкое разделение ответственности:** 
  - `Payment Service` — доменная логика платежей (резервирование, списание)
  - `FraudCheck Service` — антифрод-анализ
  - `PaymentSagaOrchestrator` — управление процессом, компенсации, таймауты
- **Соответствие паттерну Saga Orchestration:** классическая реализация с централизованным контроллером процесса
- **Превосходная наблюдаемость:** 
  - Camunda предоставляет встроенный мониторинг состояния процессов
  - Единая точка для трассировки всей транзакции (важно для команды безопасности при анализе мошенничества)
  - Возможность создания дашбордов «зависших транзакций» для операторов
- **Изолированность сбоев:** сбой в доменном сервисе не приводит к потере состояния процесса — оркестратор сохраняет контекст в БД и возобновляет выполнение после восстановления
- **Поддержка сложных сценариев:** 
  - Ручная проверка с таймаутом 20 минут легко моделируется как состояние ожидания в BPMN
  - Cut-off-time реализуется через таймеры Camunda
  - Возможность добавления новых сценариев (возвраты, сплит-платежи) без изменения доменных сервисов
- **Независимое масштабирование:** оркестратор можно масштабировать отдельно при росте объема транзакций
- **Соответствие командной структуре:** 
  - Отдел платежных сервисов фокусируется на доменной логике
  - Команда безопасности получает прозрачный доступ к состоянию проверок через интерфейс оркестратора
  - Команда поддержки использует инструменты оркестратора для ручного разрешения исключений
### Вариант №2 «Оркестрацию внутри доменных сервисов»
**Описание:** Логика управления состоянием Saga (переходы, таймауты, компенсации) реализована как часть доменного сервиса обработки платежей.


## Сравнение альтернатив
| Вариант решения           | Преимущества                                                 | Недостатки                                                |
|---------------------------|--------------------------------------------------------------|-----------------------------------------------------------|
| Вариант №1 | - Отделение оркестратора от доменных сервисов позволет избежать перемешивания бизнес логики и локик оркестрации процессом<br>- Единый сервис позволяет обеспечивать консистентное состояние саги<br>- Проще версионирвоание, возможен деплой отдельно от доменного сервиса<br> | - Появляется ещё один сервис, деплой, SLA<br>- Появление единой точки отказа<br> |
| Вариант №2 | - Меньше сервисов/деплоев<br>- Меньше сетевого трафика, нет единой точки отказа<br> | - Смешение доменной логики и процессов<br>- Менее изолированно, релиз связан с доменом<br>- Возможно перемешивание доменной логики и логики управления сага<br> - Конфликт ответственности команд: отдел платежных сервисов вынужден поддерживать инфраструктурную логику, которая критична для безопасности и финансов |

## Принятое решение
Выбран **Вариант 1:** Создание отдельного сервиса-оркестратора `PaymentSagaOrchestrator` на базе Camunda BPMN Engine.

Сервис будет:
1. Реализован как отдельный микросервис с собственным контекстом развертывания
2. Использовать встроенный Camunda BPMN Engine (embedded mode) для выполнения процессов
3. Хранить состояние процессов в выделенной схеме PostgreSQL (для изоляции от доменных данных)
4. Взаимодействовать с доменными сервисами через асинхронные команды (через брокер сообщений или HTTP с идемпотентностью)
5. Предоставлять API для:
   - Запуска нового платежного процесса
   - Просмотра состояния транзакции (для поддержки и безопасности)
   - Ручного разрешения зависших процессов (через интерфейс оператора)