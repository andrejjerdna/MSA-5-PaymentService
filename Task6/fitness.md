# Fitness-функции для платежной системы

# Fitness-функции для платежной системы

| Название функции | Назначение | Что проверяется | Действие при нарушении | Способ реализации |
|------------------|------------|-----------------|------------------------|-------------------|
| **SagaTransactionIntegrity** | Обеспечение целостности Saga-транзакций | Для каждого начатого Saga-процесса существует либо подтверждение успешного завершения (коммит), либо запись о полной компенсации (откат) | Автоматический запуск анализатора причин, повторное выполнение компенсации, уведомление ответственного инженера | Фоновый процесс, анализирующий таблицу saga_log и проверяющий наличие терминальных состояний для всех начатых транзакций старше какого-то срока обусловленного бизнес процессами |
| **StagedPaymentTimeout** | Контроль таймаутов на этапах платежа | Платежи на этапе "BLOCKED" (заблокированы) дольше 24 часов без движения | Автоматическая разблокировка средств, уведомление пользователя о необходимости подтверждения | Cron job (запуск каждый час), сканирующий записи в БД с меткой времени блокировки > 24 часов и инициирующий компенсацию |
| **StuckProcessDetector** | Выявление "зависших" процессов в оркестраторе | Процессы в Zeebe со статусом ACTIVE дольше 2 часов без выполнения новых задач | Эскалация в Slack канал #alerts, создание тикета в Jira, автоматический анализ логов | Prometheus запрос к метрикам Zeebe + AlertManager + скрипт анализа причин зависания |
| **FraudCheckDeadline** | Контроль времени выполнения антифрод-проверки | Время ответа антифрод-системы превышает 5 секунд для синхронных вызовов | Переключение на fallback-режим (manual review), логирование инцидента, уведомление команды антифрода | Мониторинг времени ответа внешних сервисов + Hystrix/Resilience4j с настройкой таймаутов |
| **SagaCompensationCompleteness** | Проверка полноты выполнения компенсаций | Для каждой неуспешной транзакции все шаги имеют соответствующие компенсирующие действия | Ручной разбор инцидента, создание задачи на доработку, частичный откат вручную | Анализ логов транзакций + проверка наличия компенсационных записей для каждого шага Saga |
| **SlaBreachDetection** | Обнаружение нарушений SLA по времени ответа | Процент запросов с временем ответа > 500 мс превышает 1% за 5 минут | Автоматическое масштабирование подов, уведомление SRE команды, создание инцидента | Prometheus + Grafana + AlertManager на основе метрик времени ответа API |
| **PaymentExpirationControl** | Контроль истечения срока действия платежей | Платежи, созданные более 7 дней назад, не завершены и не отменены | Автоматическая отмена платежа, возврат средств, уведомление пользователя | Cron job, сканирующий БД и закрывающий "висячие" платежи старше 7 дней |
| **EventProcessingLag** | Контроль задержки обработки событий | Размер очереди Kafka (consumer lag) превышает 1000 сообщений или время обработки события > 5 минут | Автоматическое увеличение количества партиций/консюмеров, уведомление команды | Мониторинг Kafka consumer lag через Prometheus + скриптинг авто-масштабирования |
| **DatabaseDeadlockDetection** | Выявление взаимоблокировок в БД | Количество deadlock-ошибок в БД превышает 5 в час | Автоматический анализ проблемных запросов, оптимизация индексов, уведомление DBA | Мониторинг логов БД + интеграция с системой анализа производительности запросов |
| **RetryExhaustionMonitor** | Контроль исчерпания попыток выполнения задач | Задачи Zeebe с количеством retries = 0 и статусом FAILED | Автоматический переход к компенсации, уведомление разработчиков сервиса в Slack | Сбор метрик по retry из Zeebe + анализ паттернов отказов через ELK стэк |
| **ExternalServiceAvailability** | Контроль доступности внешних сервисов | Антифрод-система или платежный шлюз недоступны более 1 минуты | Автоматическое переключение на резервный сервис, уведомление ответственных, включение режима degraded | Синтетические health check запросы каждые 30 секунд + мониторинг ответов |
| **NotificationDeliveryConfirm** | Подтверждение доставки уведомлений | Отсутствует подтверждение доставки уведомления клиенту в течение 5 минут | Повторная отправка, эскалация при критических уведомлениях (отказ платежа) | Мониторинг статусов отправки в сервисе уведомлений + очередь повторных попыток |
| **FraudRuleEffectiveness** | Оценка эффективности правил антифрода | Количество ложных срабатываний антифрода (одобренных вручную после отклонения) > 10% | Уведомление команды антифрода, корректировка правил, ретроспективный анализ | Аналитический job, сравнивающий решения антифрода с результатами ручных проверок |